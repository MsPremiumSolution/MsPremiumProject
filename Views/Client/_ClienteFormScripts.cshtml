@model MSPremiumProject.ViewModels.ClienteCreateViewModel

<script>
    $(document).ready(function () {
        var paisDropdown = $('#paisDropdown');
        var regiaoDropdown = $('#regiaoDropdown');
        var regioesContainer = $('#regioesContainer');
        var cpPortugalContainer = $('#cpPortugalContainer');
        var cpEstrangeiroContainer = $('#cpEstrangeiroContainer');
        var clienteNomeLocalidadeTextoInput = $('#Cliente_NomeLocalidadeTexto'); // Referência ao input do campo de texto da localidade

        var savedSelectedRegiao = "@Model.SelectedRegiao";
        var savedNomeLocalidadeTexto = "@Model.Cliente.NomeLocalidadeTexto";

        function toggleFieldsByCountry() {
            var selectedPaisOption = paisDropdown.find('option:selected');
            var selectedPaisText = selectedPaisOption.text();
            var selectedPaisId = paisDropdown.val();

            regioesContainer.hide();
            cpPortugalContainer.hide();
            cpEstrangeiroContainer.hide();

            // Limpa campos que serão ocultados
            $('#Cliente_Cp4').val('');
            $('#Cliente_Cp3').val('');
            $('#Cliente_CodigoPostalEstrangeiro').val('');
            regiaoDropdown.empty().append($('<option></option>').val('').text('-- Selecione uma Região --'));
            // Não limpa clienteNomeLocalidadeTextoInput aqui, será preenchido condicionalmente

            if (selectedPaisId) {
                if (selectedPaisText.toLowerCase() === 'portugal') {
                    regioesContainer.show();
                    cpPortugalContainer.show();
                    $('#Cliente_CodigoPostalEstrangeiro').val(''); // Garante que este campo está vazio

                    // Preenche o campo de texto da localidade com a região selecionada (para Portugal)
                    clienteNomeLocalidadeTextoInput.val(savedSelectedRegiao);

                    $.ajax({
                        url: '@Url.Action("GetRegioesPorPais", "Client")',
                        type: 'GET',
                        dataType: 'json',
                        data: { paisId: selectedPaisId },
                        success: function (data) {
                            regiaoDropdown.empty().append($('<option></option>').val('').text('-- Selecione uma Região --'));
                            if (data && data.length > 0) {
                                $.each(data, function (index, item) {
                                    var option = $('<option></option>').val(item).text(item);
                                    if (item === savedSelectedRegiao) {
                                        option.prop('selected', true);
                                    }
                                    regiaoDropdown.append(option);
                                });
                            }
                            // Assegura que o campo de texto da localidade é preenchido com a região ao carregar,
                            // caso selectedRegiao já tenha um valor.
                            if (savedSelectedRegiao) {
                                clienteNomeLocalidadeTextoInput.val(savedSelectedRegiao);
                            }
                        },
                        error: function () { console.error("Erro ao buscar regiões."); }
                    });
                } else { // Países Estrangeiros
                    cpEstrangeiroContainer.show();
                    $('#Cliente_Cp4').val(''); // Garante que estes campos estão vazios
                    $('#Cliente_Cp3').val('');

                    // Preenche o campo de texto da localidade com o valor original (para estrangeiro)
                    clienteNomeLocalidadeTextoInput.val(savedNomeLocalidadeTexto);
                    regiaoDropdown.empty().append($('<option></option>').val('').text('-- N/A --'));
                }
            } else { // Nenhum país selecionado
                clienteNomeLocalidadeTextoInput.val(''); // Limpa o campo de texto da localidade
            }
        }

        // Atualiza o campo Cliente.NomeLocalidadeTexto quando a região para Portugal muda
        regiaoDropdown.on('change', function () {
            if (paisDropdown.find('option:selected').text().toLowerCase() === 'portugal') {
                clienteNomeLocalidadeTextoInput.val(regiaoDropdown.val());
            }
        });

        paisDropdown.on('change', function () {
            // Ao mudar o país, resetamos os valores salvos para que não influenciem a nova seleção
            savedSelectedRegiao = "";
            savedNomeLocalidadeTexto = "";
            toggleFieldsByCountry();
        });

        // Executa a função no carregamento da página para definir o estado inicial
        toggleFieldsByCountry();
    });
</script>